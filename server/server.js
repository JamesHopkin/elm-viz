"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runVizServer = exports.Server = void 0;
const fs = require("fs");
const http = require("http");
const MIME_TYPES = new Map([
    ['js', 'application/javascript'],
    ['json', 'application/json'],
    ['css', 'text/css'],
    ['text', 'text/plain'],
    ['txt', 'text/plain'],
    ['html', 'text/html'],
    ['png', 'image/png'],
    ['jpg', 'image/jpeg'],
    ['gif', 'image/gif'],
    ['wasm', 'application/wasm'],
]);
function makeHeadersObject(kvs) {
    const headers = {};
    for (const [k, v] of kvs) {
        headers[k] = v;
    }
    return headers;
}
function ensureRegExp(route) {
    if (route instanceof RegExp) {
        return route;
    }
    // allow any character it wildcards at the moment
    // should maybe require ** to match /
    route = route
        .replace(/([().+?])/g, '\\$1')
        .replace(/\*/g, '([^/]*)');
    return new RegExp(`^${route}$`);
}
function writeError(response, code, message) {
    response.writeHead(code, { 'Content-Type': 'text/plain' });
    response.end(message);
}
class Server {
    constructor() {
        this.server = null;
        this.handlers = [];
    }
    open(optPort) {
        if (this.server) {
            throw new Error('already open');
        }
        const port = optPort || 80;
        this.server = new http.Server;
        this.server.on('request', (request, response) => this.onRequest(request, response));
        console.log(`Web server listening on port ${port}`);
        return new Promise((done, _fail) => this.server.listen(port, done));
    }
    close() {
        return new Promise((done, _fail) => this.server.close(done))
            .then(() => this.server = null);
    }
    addFileMapping(route, filePattern, opts) {
        let filetype = opts && opts.filetype;
        if (!filetype) {
            if (!(route instanceof RegExp)) {
                const lastDotIndex = route.lastIndexOf('.');
                if (lastDotIndex !== -1) {
                    filetype = route.substr(lastDotIndex + 1);
                }
            }
        }
        if (!filetype) {
            const lastDotIndex = filePattern.lastIndexOf('.');
            if (lastDotIndex === -1) {
                throw new Error('File type or file extension required');
            }
            filetype = filePattern.substr(lastDotIndex + 1);
        }
        if (!MIME_TYPES.has(filetype) && filetype.split('/').length !== 2) {
            throw new Error(`Unknown file type '${filetype}'`);
        }
        let encoding = null;
        let mimeType = MIME_TYPES.get(filetype);
        if (mimeType) {
            // assuming known file types other than images are text
            // HACK HACK HACK - any headers currently turn off utf8 decoding
            if (!mimeType.startsWith('image/') && !(opts && 'headers' in opts)) {
                encoding = 'utf8';
            }
        }
        else {
            mimeType = filetype;
        }
        const routeRegExp = ensureRegExp(route);
        this.handlers.push({
            route: routeRegExp,
            verb: 'GET',
            handler: (response, req, _match) => this.handleFileRequest(response, filePattern, encoding, mimeType, routeRegExp, req.url.pathname, opts && opts.headers)
        });
    }
    handleFileRequest(response, filePattern, encoding, mimeType, route, path, inHeaders) {
        const filePath = path.replace(route, filePattern);
        if (filePath.search(/\.\./) !== -1) {
            throw new Error('relative paths not allowed!');
        }
        // serve the file
        fs.readFile(filePath, encoding, (err, data) => {
            if (err) {
                writeError(response, 404, `File not found: ${filePath}`);
            }
            else {
                const headers = inHeaders ? makeHeadersObject(inHeaders) : {};
                headers['Content-Type'] = mimeType;
                response.writeHead(200, headers);
                response.end(data);
            }
        });
    }
    async onRequest(req, response) {
        let url = null;
        try {
            url = new URL(`http://${req.headers.host}${req.url}`);
        }
        catch (err) {
            console.log('Request error: ' + err);
        }
        if (!url || !url.pathname) {
            writeError(response, 500, 'URL parse failure');
            return;
        }
        //todo POST/PUT
        for (const handler of this.handlers) {
            if (req.method !== handler.verb) {
                continue;
            }
            const match = url.pathname.match(handler.route);
            if (match) {
                try {
                    await handler.handler(response, { url: url, cookies: req.headers.cookie }, match);
                }
                catch (err) {
                    writeError(response, 500, 'Internal server error: ' + err);
                }
                return;
            }
        }
        writeError(response, 404, 'Resource not found: ' + url);
    }
}
exports.Server = Server;
function runVizServer(port) {
    const s = new Server;
    s.addFileMapping('/*.js', 'js/$1.js');
    s.addFileMapping('/', 'index.html', { filetype: "text/html" });
    s.addFileMapping('/*.html', '$1.html', { filetype: "text/html" });
    s.addFileMapping('/*.wasm', '$1.wasm.gz', { filetype: "application/wasm", headers: [
            ['Cache-Control', 'max-age=' + 60 * 24 * 7],
            ['Content-Encoding', 'gzip']
        ] });
    s.addFileMapping('/*', '$1', { filetype: "text/plain" });
    s.open(port);
    return s;
}
exports.runVizServer = runVizServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL25ldy9zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUU3QixNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUMxQixDQUFDLElBQUksRUFBRSx3QkFBd0IsQ0FBQztJQUNoQyxDQUFDLE1BQU0sRUFBRSxrQkFBa0IsQ0FBQztJQUM1QixDQUFDLEtBQUssRUFBRSxVQUFVLENBQUM7SUFDbkIsQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDO0lBQ3RCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQztJQUNyQixDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUM7SUFDckIsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDO0lBQ3BCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQztJQUNyQixDQUFDLEtBQUssRUFBRSxXQUFXLENBQUM7SUFDcEIsQ0FBQyxNQUFNLEVBQUUsa0JBQWtCLENBQUM7Q0FDNUIsQ0FBQyxDQUFBO0FBRUYsU0FBUyxpQkFBaUIsQ0FBQyxHQUF1QjtJQUNqRCxNQUFNLE9BQU8sR0FBUSxFQUFFLENBQUM7SUFDeEIsS0FBSyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLEdBQUcsRUFBRTtRQUN6QixPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ2Y7SUFDRCxPQUFPLE9BQU8sQ0FBQztBQUNoQixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsS0FBc0I7SUFDM0MsSUFBSSxLQUFLLFlBQVksTUFBTSxFQUFFO1FBQzVCLE9BQU8sS0FBSyxDQUFBO0tBQ1o7SUFFRCxpREFBaUQ7SUFDakQscUNBQXFDO0lBQ3JDLEtBQUssR0FBRyxLQUFLO1NBQ1YsT0FBTyxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUM7U0FDN0IsT0FBTyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FB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QUFNLENBQUM7U0FDNUIsRUFBQyxDQUFDLENBQUE7SUFDSCxDQUFDLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBQyxRQUFRLEVBQUUsWUFBWSxFQUFDLENBQUMsQ0FBQTtJQUV0RCxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ1osT0FBTyxDQUFDLENBQUE7QUFDVCxDQUFDO0FBZEQsb0NBY0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xuXG5jb25zdCBNSU1FX1RZUEVTID0gbmV3IE1hcChbXG5cdFsnanMnLCAnYXBwbGljYXRpb24vamF2YXNjcmlwdCddLFxuXHRbJ2pzb24nLCAnYXBwbGljYXRpb24vanNvbiddLFxuXHRbJ2NzcycsICd0ZXh0L2NzcyddLFxuXHRbJ3RleHQnLCAndGV4dC9wbGFpbiddLFxuXHRbJ3R4dCcsICd0ZXh0L3BsYWluJ10sXG5cdFsnaHRtbCcsICd0ZXh0L2h0bWwnXSxcblx0WydwbmcnLCAnaW1hZ2UvcG5nJ10sXG5cdFsnanBnJywgJ2ltYWdlL2pwZWcnXSxcblx0WydnaWYnLCAnaW1hZ2UvZ2lmJ10sXG5cdFsnd2FzbScsICdhcHBsaWNhdGlvbi93YXNtJ10sXG5dKVxuXG5mdW5jdGlvbiBtYWtlSGVhZGVyc09iamVjdChrdnM6IFtzdHJpbmcsIHN0cmluZ11bXSkge1xuXHRjb25zdCBoZWFkZXJzOiBhbnkgPSB7fTtcblx0Zm9yIChjb25zdCBbaywgdl0gb2Yga3ZzKSB7XG5cdFx0aGVhZGVyc1trXSA9IHY7XG5cdH1cblx0cmV0dXJuIGhlYWRlcnM7XHRcbn1cblxuZnVuY3Rpb24gZW5zdXJlUmVnRXhwKHJvdXRlOiBSZWdFeHAgfCBzdHJpbmcpIHtcblx0aWYgKHJvdXRlIGluc3RhbmNlb2YgUmVnRXhwKSB7XG5cdFx0cmV0dXJuIHJvdXRlXG5cdH1cblxuXHQvLyBhbGxvdyBhbnkgY2hhcmFjdGVyIGl0IHdpbGRjYXJkcyBhdCB0aGUgbW9tZW50XG5cdC8vIHNob3VsZCBtYXliZSByZXF1aXJlICoqIHRvIG1hdGNoIC9cblx0cm91dGUgPSByb3V0ZVxuXHRcdFx0LnJlcGxhY2UoLyhbKCkuKz9dKS9nLCAnXFxcXCQxJylcblx0XHRcdC5yZXBsYWNlKC9cXCovZywgJyhbXi9dKiknKVxuXG5cdHJldHVybiBuZXcgUmVnRXhwKGBeJHtyb3V0ZX0kYClcbn1cblxuZnVuY3Rpb24gd3JpdGVFcnJvcihyZXNwb25zZTogaHR0cC5TZXJ2ZXJSZXNwb25zZSwgY29kZTogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcpIHtcblx0cmVzcG9uc2Uud3JpdGVIZWFkKGNvZGUsIHsnQ29udGVudC1UeXBlJzogJ3RleHQvcGxhaW4nfSlcblx0cmVzcG9uc2UuZW5kKG1lc3NhZ2UpXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2ViUmVxdWVzdCB7XG5cdHVybDogVVJMLFxuXHRjb29raWVzOiBzdHJpbmdcblx0cmVxRGF0YT86IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlcXVlc3RPcHRzIHtcblx0ZmlsZXR5cGU/OiBzdHJpbmdcblx0aGVhZGVycz86IFtzdHJpbmcsIHN0cmluZ11bXVxufVxuXG50eXBlIEhhbmRsZXJGdW5jID0gKHJlczogaHR0cC5TZXJ2ZXJSZXNwb25zZSwgcmVxOiBXZWJSZXF1ZXN0LCBtYXRjaDogc3RyaW5nW10pID0+IGFueVxuXG5pbnRlcmZhY2UgSGFuZGxlckludGVybmFsXG57XG5cdHJvdXRlOiBSZWdFeHBcblx0dmVyYjogc3RyaW5nXG5cdGhhbmRsZXI6IEhhbmRsZXJGdW5jXG59XG5cbmV4cG9ydCBjbGFzcyBTZXJ2ZXIge1xuXHRvcGVuKG9wdFBvcnQ/OiBudW1iZXIpIHtcblx0XHRpZiAodGhpcy5zZXJ2ZXIpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignYWxyZWFkeSBvcGVuJylcblx0XHR9XG5cblx0XHRjb25zdCBwb3J0ID0gb3B0UG9ydCB8fCA4MFxuXG5cdFx0dGhpcy5zZXJ2ZXIgPSBuZXcgaHR0cC5TZXJ2ZXJcblx0XHR0aGlzLnNlcnZlci5vbigncmVxdWVzdCcsIChyZXF1ZXN0LCByZXNwb25zZSkgPT4gdGhpcy5vblJlcXVlc3QocmVxdWVzdCwgcmVzcG9uc2UpKVxuXG5cdFx0Y29uc29sZS5sb2coYFdlYiBzZXJ2ZXIgbGlzdGVuaW5nIG9uIHBvcnQgJHtwb3J0fWApXG5cblx0XHRyZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKGRvbmUsIF9mYWlsKSA9PiB0aGlzLnNlcnZlciEubGlzdGVuKHBvcnQsIGRvbmUpKVxuXHR9XG5cblx0Y2xvc2UoKSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChkb25lOiAoKSA9PiB2b2lkLCBfZmFpbCkgPT4gdGhpcy5zZXJ2ZXIhLmNsb3NlKGRvbmUpKVxuXHRcdC50aGVuKCgpID0+IHRoaXMuc2VydmVyID0gbnVsbClcblx0fVxuXG5cdGFkZEZpbGVNYXBwaW5nKHJvdXRlOiBzdHJpbmcgfCBSZWdFeHAsIGZpbGVQYXR0ZXJuOiBzdHJpbmcsIG9wdHM/OiBSZXF1ZXN0T3B0cykge1xuXHRcdGxldCBmaWxldHlwZSA9IG9wdHMgJiYgb3B0cy5maWxldHlwZTtcblx0XHRpZiAoIWZpbGV0eXBlKSB7XG5cdFx0XHRpZiAoIShyb3V0ZSBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcblx0XHRcdFx0Y29uc3QgbGFzdERvdEluZGV4ID0gcm91dGUubGFzdEluZGV4T2YoJy4nKVxuXHRcdFx0XHRpZiAobGFzdERvdEluZGV4ICE9PSAtMSkge1xuXHRcdFx0XHRcdGZpbGV0eXBlID0gcm91dGUuc3Vic3RyKGxhc3REb3RJbmRleCArIDEpXG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRpZiAoIWZpbGV0eXBlKSB7XG5cdFx0XHRjb25zdCBsYXN0RG90SW5kZXggPSBmaWxlUGF0dGVybi5sYXN0SW5kZXhPZignLicpXG5cdFx0XHRpZiAobGFzdERvdEluZGV4ID09PSAtMSkge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ZpbGUgdHlwZSBvciBmaWxlIGV4dGVuc2lvbiByZXF1aXJlZCcpXG5cdFx0XHR9XG5cdFx0XHRmaWxldHlwZSA9IGZpbGVQYXR0ZXJuLnN1YnN0cihsYXN0RG90SW5kZXggKyAxKVxuXHRcdH1cblx0XHRpZiAoIU1JTUVfVFlQRVMuaGFzKGZpbGV0eXBlKSAmJiBmaWxldHlwZS5zcGxpdCgnLycpLmxlbmd0aCAhPT0gMikge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGZpbGUgdHlwZSAnJHtmaWxldHlwZX0nYClcblx0XHR9XG5cblx0XHRsZXQgZW5jb2Rpbmc6IHN0cmluZyB8IG51bGwgPSBudWxsXG5cdFx0bGV0IG1pbWVUeXBlID0gTUlNRV9UWVBFUy5nZXQoZmlsZXR5cGUpXG5cdFx0aWYgKG1pbWVUeXBlKSB7XG5cdFx0XHQvLyBhc3N1bWluZyBrbm93biBmaWxlIHR5cGVzIG90aGVyIHRoYW4gaW1hZ2VzIGFyZSB0ZXh0XG5cdFx0XHQvLyBIQUNLIEhBQ0sgSEFDSyAtIGFueSBoZWFkZXJzIGN1cnJlbnRseSB0dXJuIG9mZiB1dGY4IGRlY29kaW5nXG5cdFx0XHRpZiAoIW1pbWVUeXBlLnN0YXJ0c1dpdGgoJ2ltYWdlLycpICYmICEob3B0cyAmJiAnaGVhZGVycycgaW4gb3B0cykpIHtcblx0XHRcdFx0ZW5jb2RpbmcgPSAndXRmOCdcblx0XHRcdH1cblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRtaW1lVHlwZSA9IGZpbGV0eXBlXG5cdFx0fVxuXG5cdFx0Y29uc3Qgcm91dGVSZWdFeHAgPSBlbnN1cmVSZWdFeHAocm91dGUpXG5cdFx0dGhpcy5oYW5kbGVycy5wdXNoKHtcblx0XHRcdHJvdXRlOiByb3V0ZVJlZ0V4cCxcblx0XHRcdHZlcmI6ICdHRVQnLFxuXHRcdFx0aGFuZGxlcjogKHJlc3BvbnNlOiBodHRwLlNlcnZlclJlc3BvbnNlLCByZXE6IFdlYlJlcXVlc3QsIF9tYXRjaDogc3RyaW5nW10pID0+XG5cdFx0XHRcdHRoaXMuaGFuZGxlRmlsZVJlcXVlc3QocmVzcG9uc2UsIGZpbGVQYXR0ZXJuLCBlbmNvZGluZywgbWltZVR5cGUhLCByb3V0ZVJlZ0V4cCwgcmVxLnVybC5wYXRobmFtZSEsIG9wdHMgJiYgb3B0cy5oZWFkZXJzKVxuXHRcdH0pXG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZUZpbGVSZXF1ZXN0KHJlc3BvbnNlOiBodHRwLlNlcnZlclJlc3BvbnNlLCBmaWxlUGF0dGVybjogc3RyaW5nLCBlbmNvZGluZzogc3RyaW5nIHwgbnVsbCxcblx0XHRcdFx0XHRcdFx0XHRtaW1lVHlwZTogc3RyaW5nLCByb3V0ZTogUmVnRXhwLCBwYXRoOiBzdHJpbmcsIGluSGVhZGVycz86IFtzdHJpbmcsIHN0cmluZ11bXSkge1xuXHRcdGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXBsYWNlKHJvdXRlLCBmaWxlUGF0dGVybilcblx0XHRpZiAoZmlsZVBhdGguc2VhcmNoKC9cXC5cXC4vKSAhPT0gLTEpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcigncmVsYXRpdmUgcGF0aHMgbm90IGFsbG93ZWQhJylcblx0XHR9XG5cblx0XHQvLyBzZXJ2ZSB0aGUgZmlsZVxuXHRcdGZzLnJlYWRGaWxlKGZpbGVQYXRoLCBlbmNvZGluZywgKGVyciwgZGF0YSkgPT4ge1xuXHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHR3cml0ZUVycm9yKHJlc3BvbnNlLCA0MDQsIGBGaWxlIG5vdCBmb3VuZDogJHtmaWxlUGF0aH1gKVxuXHRcdFx0fVxuXHRcdFx0ZWxzZSB7XG5cdFx0XHRcdGNvbnN0IGhlYWRlcnMgPSBpbkhlYWRlcnMgPyBtYWtlSGVhZGVyc09iamVjdChpbkhlYWRlcnMpIDoge31cblx0XHRcdFx0aGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSBtaW1lVHlwZVxuXHRcdFx0XHRyZXNwb25zZS53cml0ZUhlYWQoMjAwLCBoZWFkZXJzKVxuXHRcdFx0XHRyZXNwb25zZS5lbmQoZGF0YSlcblx0XHRcdH1cblx0XHR9KVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBvblJlcXVlc3QocmVxOiBodHRwLkluY29taW5nTWVzc2FnZSwgcmVzcG9uc2U6IGh0dHAuU2VydmVyUmVzcG9uc2UpIHtcblx0XHRsZXQgdXJsID0gbnVsbFxuXHRcdHRyeSB7XG5cdFx0XHR1cmwgPSBuZXcgVVJMKGBodHRwOi8vJHtyZXEuaGVhZGVycy5ob3N0fSR7cmVxLnVybCF9YClcblx0XHR9XG5cdFx0Y2F0Y2ggKGVycikge1xuXHRcdFx0Y29uc29sZS5sb2coJ1JlcXVlc3QgZXJyb3I6ICcgKyBlcnIsIClcblx0XHR9XG5cblx0XHRpZiAoIXVybCB8fCAhdXJsLnBhdGhuYW1lKSB7XG5cdFx0XHR3cml0ZUVycm9yKHJlc3BvbnNlLCA1MDAsICdVUkwgcGFyc2UgZmFpbHVyZScpXG5cdFx0XHRyZXR1cm5cblx0XHR9XG5cblx0XHQvL3RvZG8gUE9TVC9QVVRcblxuXHRcdGZvciAoY29uc3QgaGFuZGxlciBvZiB0aGlzLmhhbmRsZXJzKSB7XG5cdFx0XHRpZiAocmVxLm1ldGhvZCAhPT0gaGFuZGxlci52ZXJiKSB7XG5cdFx0XHRcdGNvbnRpbnVlXG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IG1hdGNoID0gdXJsLnBhdGhuYW1lLm1hdGNoKGhhbmRsZXIucm91dGUpXG5cdFx0XHRpZiAobWF0Y2gpIHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRhd2FpdCBoYW5kbGVyLmhhbmRsZXIocmVzcG9uc2UsIHt1cmw6IHVybCwgY29va2llczogcmVxLmhlYWRlcnMuY29va2llIGFzIHN0cmluZ30sIG1hdGNoKVxuXHRcdFx0XHR9XG5cdFx0XHRcdGNhdGNoIChlcnIpIHtcblx0XHRcdFx0XHR3cml0ZUVycm9yKHJlc3BvbnNlLCA1MDAsICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3I6ICcgKyBlcnIpXG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuXG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0d3JpdGVFcnJvcihyZXNwb25zZSwgNDA0LCAnUmVzb3VyY2Ugbm90IGZvdW5kOiAnICsgdXJsKVxuXHR9XG5cblx0cHJpdmF0ZSBzZXJ2ZXI6IGh0dHAuU2VydmVyIHwgbnVsbCA9IG51bGxcblx0cHJpdmF0ZSBoYW5kbGVyczogSGFuZGxlckludGVybmFsW10gPSBbXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcnVuVml6U2VydmVyKHBvcnQ6IG51bWJlcikge1xuXHRjb25zdCBzID0gbmV3IFNlcnZlclxuXG5cdHMuYWRkRmlsZU1hcHBpbmcoJy8qLmpzJywgJ2pzLyQxLmpzJylcblx0cy5hZGRGaWxlTWFwcGluZygnLycsICdpbmRleC5odG1sJywge2ZpbGV0eXBlOiBcInRleHQvaHRtbFwifSlcblx0cy5hZGRGaWxlTWFwcGluZygnLyouaHRtbCcsICckMS5odG1sJywge2ZpbGV0eXBlOiBcInRleHQvaHRtbFwifSlcblx0cy5hZGRGaWxlTWFwcGluZygnLyoud2FzbScsICckMS53YXNtLmd6Jywge2ZpbGV0eXBlOiBcImFwcGxpY2F0aW9uL3dhc21cIiwgaGVhZGVyczogW1xuXHRcdFsnQ2FjaGUtQ29udHJvbCcsICdtYXgtYWdlPScgKyA2MCoyNCo3XSxcblx0XHRbJ0NvbnRlbnQtRW5jb2RpbmcnLCAnZ3ppcCddXG5cdF19KVxuXHRzLmFkZEZpbGVNYXBwaW5nKCcvKicsICckMScsIHtmaWxldHlwZTogXCJ0ZXh0L3BsYWluXCJ9KVxuXG5cdHMub3Blbihwb3J0KVxuXHRyZXR1cm4gc1xufVxuIl19